<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/ETHFarm.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> ETHFarm.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">94.29% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>66/70</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">68.75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>22/32</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">80% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>12/15</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">93.06% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>67/72</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">8×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-yes">18×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity ^0.6.2;
pragma experimental ABIEncoderV2;
&nbsp;
// import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/math/SafeMath.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/Pausable.sol";
&nbsp;
import "./interfaces/IVOT.sol";
import "./interfaces/IProposal.sol";
&nbsp;
contract ETHFarm is ReentrancyGuard, Pausable {
    using SafeMath for uint256;
    address public owner;
    IERC20 feth;
    IVOT vot;
    struct Proposal {
        bool status;
        uint256 votes;
        uint256 expired;  //block number
        bool unactive;
    }
    address[] public proposalIndex;
    address[] public moneyBag;
&nbsp;
    uint256 public LOCK_INTERVAL = 120;
    mapping (address =&gt; bool) private tempAuth;
    mapping (address =&gt; uint256) private freezeAsset; //unfreeze blocknumber;
    mapping (address =&gt; Proposal) public proposals;
    event Deposit(address holder, uint256 amount);
    event Withdraw(address holder, uint256 amount);
    event ProposalStatus(address proposalAddr, Proposal proposal);
&nbsp;
<span class="fstat-no" title="function not covered" >    modifier onlyOwner() {</span>
<span class="cstat-no" title="statement not covered" >        require(owner == msg.sender, "Ownable: caller is not the owner")</span>;
        _;
    }
    modifier onlyTempAuth() {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(tempAuth[msg.sender], "Ownable: caller is not authorized");
        _;
    }
    constructor(IERC20 ETH, IVOT initVot) public {
        owner = msg.sender;
        feth = ETH;
        vot = initVot;
    }
&nbsp;
    //deposit feth
    function deposit(uint256 amountFETH) external nonReentrant whenNotPaused returns (uint256 liquidity) {
&nbsp;
        if (vot.totalSupply() == 0) {
            liquidity = amountFETH;
        } else {
            uint256 ETHAmount = feth.balanceOf(address(this));
&nbsp;
            for(uint256 i =0; i &lt; moneyBag.length; i++) {
                ETHAmount = ETHAmount.add(IProposal(moneyBag[i]).getBalance());
            }
&nbsp;
            uint256 share = amountFETH.mul(1e18).div(ETHAmount);
            liquidity = share.mul(vot.totalSupply()).div(1e18);
        }
        <span class="missing-if-branch" title="else path not taken" >E</span>require(feth.transferFrom(msg.sender, address(this), amountFETH), "deposit failed");
        vot.mint(msg.sender, liquidity);
        emit Deposit(msg.sender, amountFETH);
    }
    function withdraw(uint256 amountVOT) external nonReentrant returns (uint256 withdrawAmount) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(amountVOT &lt;= vot.totalSupply(), "not enouth token to burn");
        uint256 share = amountVOT.mul(1e18).div(vot.totalSupply());
&nbsp;
        uint256 ETHAmount = feth.balanceOf(address(this));
        for(uint256 i =0; i &lt; moneyBag.length; i++) {
<span class="cstat-no" title="statement not covered" >            ETHAmount = ETHAmount.add(IProposal(moneyBag[i]).getBalance())</span>;
        }
        withdrawAmount = share.mul(ETHAmount).div(1e18);
        vot.burn(msg.sender, amountVOT);
        
        <span class="missing-if-branch" title="else path not taken" >E</span>require(feth.transfer(msg.sender, withdrawAmount), "withdraw failed");
        emit Withdraw(msg.sender, amountVOT);
    }
&nbsp;
    function getCurrentRate() external view returns (uint256 currentRate) {
        uint256 share = uint256(1e18).mul(1e18).div(vot.totalSupply());
        uint256 FETHAmount = feth.balanceOf(address(this));
        currentRate = share.mul(FETHAmount).div(1e18);
    }
    //TODO get share amount out
    //TODO vot
    //TODO start and stop
    function vote(address proposal) external nonReentrant returns (bool status, uint256 votes) {
&nbsp;
            //vot shouldn't be freezed
        // if (active) {
&nbsp;
            <span class="missing-if-branch" title="else path not taken" >E</span>require(!proposals[proposal].status, "proposal signed");
            <span class="missing-if-branch" title="else path not taken" >E</span>require(proposals[proposal].votes == 0 || proposals[proposal].expired &gt; block.number, "proposal expired");
            require(!vot.isFreezed(msg.sender), "asset is freezed");
            vot.freeze(msg.sender);
            // vot.freeze(msg.sender);
            if (proposals[proposal].votes == 0) {
                proposals[proposal].expired = block.number + vot.freezeInterval();
                proposalIndex.push(proposal);
            }
            uint256 investAmount = IProposal(proposal).INVEST_ETH();
            if ( investAmount &gt; 0) {
                moneyBag.push(proposal);
            }
            proposals[proposal].votes = proposals[proposal].votes.add(vot.balanceOf(msg.sender));
            uint256 share = proposals[proposal].votes.mul(1e18).div(vot.totalSupply()); 
&nbsp;
            if (share &gt;= 66e16) {  //approve vote above 66% of total supply VOT
&nbsp;
                //open temp auth
                tempAuth[proposal] = true;
                proposals[proposal].status = true;
                //active proposal
                feth.approve(proposal, investAmount);
                IProposal(proposal).active();
                emit ProposalStatus(proposal, proposals[proposal]);
&nbsp;
                //close temp auth
                tempAuth[proposal] = false;
            }
        // } else {
        //     require(proposals[proposal].status &amp;&amp; proposals[proposal].votes &gt; 0, "proposal must be signed");
        //     //vot shouldn't be freezed
        //     require(!vot.isFreezed(msg.sender), "asset is freezed");
        //     if (!proposals[proposal].unactive) {
        //        proposals[proposal].votes = 0; 
        //     }
        //     proposals[proposal].unactive = true;
        //     proposals[proposal].votes = proposals[proposal].votes.add(vot.balanceOf(msg.sender));
        //     uint256 share = proposals[proposal].votes.mul(1e18).div(vot.totalSupply()); 
        //     if (share &gt;= 66e16) {  //approve vote above 66% of total supply VOT
            
        //         proposals[proposal].status = false;
        //         proposals[proposal].votes = 0;
        //         proposals[proposal].expired = 0;
        //         IProposal(proposal).unActive();
        //     }
&nbsp;
        // }
&nbsp;
    }
<span class="fstat-no" title="function not covered" >    function getMoneyBagByIndex(uint256 index) external view returns (address bag) {</span>
<span class="cstat-no" title="statement not covered" >        bag = moneyBag[index]</span>;
    }
&nbsp;
    function getProposalNumber() external view returns (uint256 length) {
        length = proposalIndex.length;
    }
    function getProposalByIndex(uint256 index) external view returns (address proposal, bool status, uint256 votes, uint256 expired) {
        proposal = proposalIndex[index];
        status = proposals[proposal].status;
        votes = proposals[proposal].votes; 
        expired = proposals[proposal].expired;
    }
    function getProposal(address proposal) external view returns (bool status, uint256 votes, uint256 expired) {
        status = proposals[proposal].status;
        votes = proposals[proposal].votes; 
        expired = proposals[proposal].expired;
    }
    function pause() external onlyTempAuth {
        _pause();
    }
    function unpause() external onlyTempAuth {
        _unpause();
    }
    function unActiveVot(address proposal) external {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(proposals[proposal].status &amp;&amp; proposals[proposal].votes &gt; 0, "proposal must be signed");
        
        //vot shouldn't be freezed
        <span class="missing-if-branch" title="else path not taken" >E</span>require(!vot.isFreezed(msg.sender), "asset is freezed");
        if (!proposals[proposal].unactive) {
            proposals[proposal].votes = 0; 
        }
&nbsp;
        proposals[proposal].unactive = true;
        proposals[proposal].votes = proposals[proposal].votes.add(vot.balanceOf(msg.sender));
        uint256 share = proposals[proposal].votes.mul(1e18).div(vot.totalSupply()); 
&nbsp;
        if (share &gt;= 66e16) {  //approve vote above 66% of total supply VOT
        
            proposals[proposal].status = false;
            proposals[proposal].votes = 0;
            proposals[proposal].expired = 0;
            IProposal(proposal).unActive();
        }
    }
<span class="fstat-no" title="function not covered" >    function closeCompound(address proposal) external {</span>
<span class="cstat-no" title="statement not covered" >        IProposal(proposal).unActive()</span>;
    }
    receive() external payable {}
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sun Aug 09 2020 02:44:04 GMT+0800 (GMT+08:00)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
